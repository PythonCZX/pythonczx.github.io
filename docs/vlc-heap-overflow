<!DOCTYPE html><html lang="en" data-theme="classic"><head><title>Heap Buffer Overflow in VLC v0.9.4</title><link rel="shortcut icon" href="/assets/img/favicon.ico"><link rel="alternate" type="application/rss+xml" title="All Content Feed" href="https://shellsharks.com/feeds/all-feed.xml"><link rel="alternate" type="application/rss+xml" title="Post Feed" href="https://shellsharks.com/feeds/feed.xml"><link rel="alternate" type="application/rss+xml" title="Scrolls Feed" href="https://shellsharks.com/feeds/scroll-feed.xml"><link rel="alternate" type="application/rss+xml" title="Infosec Feed" href="https://shellsharks.com/feeds/infosec-feed.xml"><link rel="alternate" type="application/rss+xml" title="Notes Feed" href="https://shellsharks.com/feeds/note-feed.xml"><link rel="alternate" type="application/rss+xml" title="Devlogs Feed" href="https://shellsharks.com/feeds/devlog-feed.xml"><link rel="alternate" type="application/rss+xml" title="Links Feed" href="https://shellsharks.com/feeds/link-feed.xml"><link rel="alternate" type="application/rss+xml" title="Captains Log Feed" href="https://shellsharks.com/feeds/log-feed.xml"><link rel="alternate" type="application/rss+xml" title="Social Web Feed" href="https://shellsharks.com/feeds/socialweb-feed.xml"><link rel="alternate" type="application/rss+xml" title="Life Feed" href="https://shellsharks.com/feeds/life-feed.xml"><link rel="blogroll" type="text/xml" href="https://shellsharks.com/assets/rsrc/shellsharks-blogroll.opml"><link type="text/plain" rel="author" href="https://shellsharks.com/humans.txt" /><link rel="canonical" href="https://shellsharks.com/vlc-heap-overflow"><link rel="apple-touch-icon" href="/assets/img/apple-touch-icon.png"><link rel="indieweb" href="/indieweb.txt" /><link href="https://github.com/shellsharks" rel="me"> <!--IndieAuth Provider--><link rel="authorization_endpoint" href="https://indieauth.com/auth"> <!--IndieAuth--><link rel="token_endpoint" href="https://tokens.indieauth.com/token"> <!--IndieAuth token endpoint--> <!--needed for button css--><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous"><link href='/assets/css/style.css' rel='stylesheet' type='text/css'><link href="/assets/css/syntax.css" rel="stylesheet" ><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" /><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" /><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css" /><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Michael Sass" /><meta name="description" content="A walkthrough of identifying a heap-based buffer overflow vulnerability in VLC." /><meta name="keywords" content="Heap Buffer Overflow in VLC v0.9.4, shellsharks, dev, cve, infosec, red, reverseengineering, ida, exploitdev, technical" /><meta content="shellsharks" property="og:site_name" /><meta name="fediverse:creator" content="@shellsharks@shellsharks.social" /><meta name="robots" content="noai, noimageai, noml" /> <!--https://noml.info--> <script> const currentThemeX = localStorage.getItem('theme') ? localStorage.getItem('theme') : null; if (currentThemeX) { document.documentElement.setAttribute('data-theme', currentThemeX); } else if (matchMedia('(prefers-color-scheme: light)').matches) { localStorage.setItem('theme', "light"); } else if (matchMedia('(prefers-color-scheme: dark)').matches) { localStorage.setItem('theme', "classic"); } else { localStorage.setItem('theme', "classic"); } </script><meta content="Heap Buffer Overflow in VLC v0.9.4" property="og:title"><meta content="article" property="og:type"><meta content="A walkthrough of identifying a heap-based buffer overflow vulnerability in VLC." property="og:description"><meta content="https://shellsharks.com/vlc-heap-overflow" property="og:url"><meta content="2019-10-08T01:00:00-04:00" property="article:published_time"><meta content="https://shellsharks.com/about/" property="article:author"><meta content="https://shellsharks-images.s3.amazonaws.com/2019/vlc.mini.svg" property="og:image"><meta content="infosec" property="article:section"><meta content="dev" property="article:tag"><meta content="cve" property="article:tag"><meta content="infosec" property="article:tag"><meta content="red" property="article:tag"><meta content="reverseengineering" property="article:tag"><meta content="ida" property="article:tag"><meta content="exploitdev" property="article:tag"><meta content="technical" property="article:tag"> <script src="/assets/js/finrand.js"></script><style> @media (max-width: 2048px) { main { width:66%; } } @media (max-width: 1800px) { main { max-width:800px; width:95%; } } @media (max-width: 768px) { main { width:95%; } }</style><body><div class="container"><heading class="container_item"><style> /* * Made by Erik Terwan * 24th of November 2015 * MIT License * * * If you are thinking of using this in * production code, beware of the browser * prefixes. */ #menuToggle { display: block; position: relative; z-index: 1; -webkit-user-select: none; user-select: none; } #menuToggle a { text-decoration: none; transition: color 0.3s ease; color: var(--contrast-font-color); } .menu_section { color: var(--light-font-color); font-weight: 900; } .menu_section:nth-of-type(n+2) { margin-top:20px; } #menuToggle a:hover { color: var(--link-hover-color); } #menuToggle input { display: block; width: 40px; height: 32px; position: absolute; /*top: -7px;*/ /*left: -5px;*/ cursor: pointer; opacity: 0; /* hide this */ z-index: 2; /* and place it over the hamburger */ -webkit-touch-callout: none; } /* * Just a quick hamburger */ #menuToggle span { display: block; width: 27px; height: 3px; margin-bottom: 4px; position: relative; margin-top:4px; background: var(--font-color); border-radius: 3px; z-index: 1; transform-origin: 4px 0px; transition: transform 0.5s cubic-bezier(0.77,0.2,0.05,1.0), background 0.5s cubic-bezier(0.77,0.2,0.05,1.0), opacity 0.55s ease; } #menuToggle span:first-child { transform-origin: 0% 0%; } #menuToggle span:nth-last-child(2) { transform-origin: 0% 100%; } /* * Transform all the slices of hamburger * into a crossmark. */ #menuToggle input:checked ~ span { opacity: 1; transform: rotate(45deg) translate(-2px, -1px); background: var(--link-hover-color); } /* * But let's hide the middle one. */ #menuToggle input:checked ~ span:nth-last-child(3) { opacity: 0; transform: rotate(0deg) scale(0.2, 0.2); } /* * Ohyeah and the last one should go the other direction */ #menuToggle input:checked ~ span:nth-last-child(2) { transform: rotate(-45deg) translate(0, -1px); } /* * Make this absolute positioned * at the top left of the screen */ #menu { position: absolute; left:-10px; width: 200px; /*fit-content;*/ padding: 10px; margin-top:10px; /*display:none;*/ background: var(--light-background-color); color:var(--font-color); list-style-type: none; -webkit-font-smoothing: antialiased; max-height: calc(80vh); overflow:auto; overscroll-behavior: contain; border-radius: 5px; /* to stop flickering of text in safari */ } /* * And let's slide it in from the left */ #menuToggle input:checked ~ ul { display:block; } .hidden { display: none; }</style><div role="navigation" id="hamburger"><div id="menuToggle"> <input type="checkbox" /> <span></span> <span></span> <span></span><ul id="menu" class="hidden"><li class="menu_section">Main<li><a href="/home/feed" ><i class="ph ph-house"></i> Home Feed</a><li><a href="/about" ><i class="ph ph-identification-card"></i> About</a><li><a href="/feeds" ><i class="ph ph-rss"></i> Feeds</a><li><a href="/activity" ><i class="ph ph-pulse"></i> Activity</a><li><a href="https://shellsharks.social/@shellsharks" target="_blank"><i class="ph ph-mastodon-logo"></i> Mastodon</a><li><a href="mailto:mike@shellsharks.com" ><i class="ph ph-envelope"></i> Email</a><li><a href="https://ko-fi.com/shellsharks" ><i class="ph ph-coffee"></i> Buy me a Coffee</a><li id="themetoggler"><i class="ph ph-swatches" id="themetoggle"></i> Toggle theme<li class="menu_section">Site Nav<li><a href="/scrolls" ><i class="ph ph-scroll"></i> Scrolls Newsletter</a><li><a href="/podcast" ><i class="ph ph-microphone"></i> The Shellsharks Podcast</a><li><a href="/notebook" ><i class="ph ph-note"></i> Notebook</a><li><a href="/blogs" ><i class="ph ph-article"></i> Blogs</a><li><a href="/blogs/infosec" ><i class="ph ph-bug"></i> Infosec Blogs</a><li><a href="/captains-log" ><i class="ph-fill ph-notebook"></i> Captain's Log</a><li><a href="/devlog" ><i class="ph ph-code-block"></i> Devlog</a><li><a href="/linklog" ><i class="ph ph-link"></i> Linklog</a><li><a href="/blogroll" ><i class="ph ph-paint-roller"></i> Blogroll</a><li><a href="/fediverse" ><i class="ph ph-fediverse-logo"></i> Fediverse ⁂</a><li><a href="/slashes" ><i class="ph ph-folder-simple-star"></i> Slashes</a><li><a href="/uses" ><i class="ph ph-hammer"></i> Uses</a><li><a href="/now" ><i class="ph ph-clock"></i> Now</a><li><a href="/tags" ><i class="ph ph-tag"></i> Tags</a><li><a href="/statboard" ><i class="ph ph-gauge"></i> Statboard</a><li><a href="/changelog" ><i class="ph ph-arrows-left-right"></i> Change Log</a><li><a href="/interests" ><i class="ph ph-heart"></i> Interests</a><li><a href="/ideas" ><i class="ph ph-lightbulb-filament"></i> Ideas</a><li><a href="/bookmarks" ><i class="ph ph-bookmarks"></i> Bookmarks</a><li><a href="/resume" ><i class="ph ph-read-cv-logo"></i> Resume</a><li><a href="/pro" ><i class="ph ph-seal"></i> Shellsharks Pro</a><li><a href="/sharkweek" ><i class="ph ph-calendar-heart"></i> >Shark Week</a><li><a href="/architecture" ><i class="ph ph-blueprint"></i> Architecture</a><li><a href="/roadmap" ><i class="ph ph-road-horizon"></i> Roadmap</a><li><a href="/tags?tag=bestof#info" ><i class="ph ph-star"></i> Best</a><li><a href="/projects" ><i class="ph ph-compass-tool"></i> Projects</a><li><a href="/now#supporting" ><i class="ph ph-hand-heart"></i> Supports</a><li><a href="/uses#referrals" ><i class="ph ph-hand-arrow-up"></i> Referrals</a><li><a href="/style" ><i class="ph ph-frame-corners"></i> Style</a><li><a href="/.well-known/security.txt" ><i class="ph ph-bug"></i> Report a Bug</a><li><a href="/humans.txt" ><i class="ph ph-user-rectangle"></i> Humans</a><li><a href="/disclaimer" ><i class="ph ph-info"></i> License & Disclaimer</a><li><a href="/privacy" ><i class="ph ph-cookie"></i> Privacy</a><li><a href="/starsharks" ><i class="ph ph-sparkle"></i> Starsharks</a><li><a href="/chipotle" ><i class="ph ph-pepper"></i> Chipotle</a><li><a href="/misc" ><i class="ph ph-paperclip"></i> Junk Drawer</a><li><a href="/ocean" ><i class="ph ph-waves"></i> the Ocean</a><li><a href="/void" ><i class="ph ph-spiral"></i> the Void</a><li class="menu_section">Other<li><a href="/public.pgp" ><i class="ph ph-key"></i> PGP Public Key</a><li><a href="https://infosec.pub/c/cybersecurity" target="_blank"><i class="ph ph-hamburger"></i> Infosec.Pub</a><li><a href="https://malici.ous.computer/@shellsharks" target="_blank"><i class="ph ph-linux-logo"></i> malici.ous.computer</a><li><a href="https://mastodon.social/@sass" target="_blank"><i class="ph-fill ph-mastodon-logo"></i> Mastodon.Social</a><li><a href="https://discord.gg/3rkHgtcYbb" target="_blank"><i class="ph ph-discord-logo"></i> Shellsharks Discord</a><li><a href="https://www.linkedin.com/in/mikesass" target="_blank"><i class="ph ph-linkedin-logo"></i> Linkedin</a><li><a href="/toots/infosec-exchange/shellsharks/" ><i class="ph ph-database"></i> Infosec.exchange Toot Archive</a><li><a href="https://github.com/shellsharks" target="_blank"><i class="ph ph-github-logo"></i> Github</a><li><a href="https://fediverse-webring-enthusiasts.glitch.me/profiles/shellsharks_infosec.exchange/index.html" target="_blank"><i class="ph ph-circle"></i> Webring Enthusiasts</a><li><a href="https://fedia.io/m/cybersecurity" target="_blank"><i class="ph ph-square-half"></i> Fedia.io</a><li><img src="/assets/img/avatar.png" height="50" style="position: relative; display: block; margin:auto; margin-top:20px; margin-bottom:20px;" /></ul></div></div><!-- window.onload = function() { var menuButton = document.getElementById('menuToggle'); var menu = document.getElementById('menu'); menu.classList.add('hidden'); document.getElementById("menuToggle").children[0].checked = false; } --> <script> const menuButton = document.getElementById('menuToggle'); const menu = document.getElementById('menu'); var links = menu.querySelectorAll('a'); menuButton.addEventListener('click', () => { if (!menu.contains(event.target)) { menu.classList.toggle('hidden'); } }); document.addEventListener('click', (event) => { if (!menu.contains(event.target) && !menuButton.contains(event.target)) { menu.classList.add('hidden'); if (document.getElementById("menuToggle").children[0].checked) { document.getElementById("menuToggle").children[0].checked = !document.getElementById("menuToggle").children[0].checked; } } }); links.forEach(function(link) { link.addEventListener('click', function(event) { document.querySelector("#hamburger").click(); }); }); </script> <img id="title_image" src="/assets/img/shellsharks.gif" alt="Shellsharks>_" onclick='window.open("/","_self")'> <span style="float:right;"><a href="/search"><i class="ph-bold ph-magnifying-glass" style="color:var(--font-color); font-size:1.6em; top:-2px;"></i></a></span> </heading><nav class="container_item"><ul id="nav_menu" style="list-style-type:none;padding-left: 10px;"><li class="menu_section">Main<li><a href="/home/feed" ><i class="ph ph-house"></i> Home Feed</a><li><a href="/about" ><i class="ph ph-identification-card"></i> About</a><li><a href="/feeds" ><i class="ph ph-rss"></i> Feeds</a><li><a href="/activity" ><i class="ph ph-pulse"></i> Activity</a><li><a href="https://shellsharks.social/@shellsharks" target="_blank"><i class="ph ph-mastodon-logo"></i> Mastodon</a><li><a href="mailto:mike@shellsharks.com" ><i class="ph ph-envelope"></i> Email</a><li><a href="https://ko-fi.com/shellsharks" ><i class="ph ph-coffee"></i> Buy me a Coffee</a><li id="themetoggler"><i class="ph ph-swatches" id="themetoggle"></i> Toggle theme<li class="menu_section">Site Nav<li><a href="/scrolls" ><i class="ph ph-scroll"></i> Scrolls Newsletter</a><li><a href="/podcast" ><i class="ph ph-microphone"></i> The Shellsharks Podcast</a><li><a href="/notebook" ><i class="ph ph-note"></i> Notebook</a><li><a href="/blogs" ><i class="ph ph-article"></i> Blogs</a><li><a href="/blogs/infosec" ><i class="ph ph-bug"></i> Infosec Blogs</a><li><a href="/captains-log" ><i class="ph-fill ph-notebook"></i> Captain's Log</a><li><a href="/devlog" ><i class="ph ph-code-block"></i> Devlog</a><li><a href="/linklog" ><i class="ph ph-link"></i> Linklog</a><li><a href="/blogroll" ><i class="ph ph-paint-roller"></i> Blogroll</a><li><a href="/fediverse" ><i class="ph ph-fediverse-logo"></i> Fediverse ⁂</a><li><a href="/slashes" ><i class="ph ph-folder-simple-star"></i> Slashes</a><li><a href="/uses" ><i class="ph ph-hammer"></i> Uses</a><li><a href="/now" ><i class="ph ph-clock"></i> Now</a><li><a href="/tags" ><i class="ph ph-tag"></i> Tags</a><li><a href="/statboard" ><i class="ph ph-gauge"></i> Statboard</a><li><a href="/changelog" ><i class="ph ph-arrows-left-right"></i> Change Log</a><li><a href="/interests" ><i class="ph ph-heart"></i> Interests</a><li><a href="/ideas" ><i class="ph ph-lightbulb-filament"></i> Ideas</a><li><a href="/bookmarks" ><i class="ph ph-bookmarks"></i> Bookmarks</a><li><a href="/resume" ><i class="ph ph-read-cv-logo"></i> Resume</a><li><a href="/pro" ><i class="ph ph-seal"></i> Shellsharks Pro</a><li><a href="/sharkweek" ><i class="ph ph-calendar-heart"></i> >Shark Week</a><li><a href="/architecture" ><i class="ph ph-blueprint"></i> Architecture</a><li><a href="/roadmap" ><i class="ph ph-road-horizon"></i> Roadmap</a><li><a href="/tags?tag=bestof#info" ><i class="ph ph-star"></i> Best</a><li><a href="/projects" ><i class="ph ph-compass-tool"></i> Projects</a><li><a href="/now#supporting" ><i class="ph ph-hand-heart"></i> Supports</a><li><a href="/uses#referrals" ><i class="ph ph-hand-arrow-up"></i> Referrals</a><li><a href="/style" ><i class="ph ph-frame-corners"></i> Style</a><li><a href="/.well-known/security.txt" ><i class="ph ph-bug"></i> Report a Bug</a><li><a href="/humans.txt" ><i class="ph ph-user-rectangle"></i> Humans</a><li><a href="/disclaimer" ><i class="ph ph-info"></i> License & Disclaimer</a><li><a href="/privacy" ><i class="ph ph-cookie"></i> Privacy</a><li><a href="/starsharks" ><i class="ph ph-sparkle"></i> Starsharks</a><li><a href="/chipotle" ><i class="ph ph-pepper"></i> Chipotle</a><li><a href="/misc" ><i class="ph ph-paperclip"></i> Junk Drawer</a><li><a href="/ocean" ><i class="ph ph-waves"></i> the Ocean</a><li><a href="/void" ><i class="ph ph-spiral"></i> the Void</a><li class="menu_section">Other<li><a href="/public.pgp" ><i class="ph ph-key"></i> PGP Public Key</a><li><a href="https://infosec.pub/c/cybersecurity" target="_blank"><i class="ph ph-hamburger"></i> Infosec.Pub</a><li><a href="https://malici.ous.computer/@shellsharks" target="_blank"><i class="ph ph-linux-logo"></i> malici.ous.computer</a><li><a href="https://mastodon.social/@sass" target="_blank"><i class="ph-fill ph-mastodon-logo"></i> Mastodon.Social</a><li><a href="https://discord.gg/3rkHgtcYbb" target="_blank"><i class="ph ph-discord-logo"></i> Shellsharks Discord</a><li><a href="https://www.linkedin.com/in/mikesass" target="_blank"><i class="ph ph-linkedin-logo"></i> Linkedin</a><li><a href="/toots/infosec-exchange/shellsharks/" ><i class="ph ph-database"></i> Infosec.exchange Toot Archive</a><li><a href="https://github.com/shellsharks" target="_blank"><i class="ph ph-github-logo"></i> Github</a><li><a href="https://fediverse-webring-enthusiasts.glitch.me/profiles/shellsharks_infosec.exchange/index.html" target="_blank"><i class="ph ph-circle"></i> Webring Enthusiasts</a><li><a href="https://fedia.io/m/cybersecurity" target="_blank"><i class="ph ph-square-half"></i> Fedia.io</a></ul></nav><main class="container_item"><div class="pageheader"></div><article class="post h-entry"><header class="post-header"><h1 class="post-title p-name" id="title" style="display:inline;">Heap Buffer Overflow in VLC v0.9.4</h1><span style="color:#CA3342;font-size:4em;line-height: 20px;">.</span></header><!--<div id="postinfo"> <span class="time"><i class="ph ph-note-pencil"></i> by <span class="hov p-author h-card">Mike Sass</span> <a href="/about" rel="author"><img class="u-photo" src="https://shellsharks-images.s3.amazonaws.com/surfshark.png" style="display:inline; height:1em;" /></a></span><br/> <br/> <span class="categories"> &raquo; infosec, blog </span></div>--><div class="post-content e-content" style="margin-top: 30px;"><p>A <a href="/vlc-stack-overflow#title">previous post</a> analyzed a stack buffer-overflow in the <em>parse_master</em> function of VLC &lt;=v0.9.4. <em>parse_master</em> is susceptible to another vulnerability, this time of the <strong>heap-overflow</strong> variety.<p><strong>*</strong> <em>Following this analysis requires some understanding of <a href="/intel-assembly-primer#title">Intel assembly and basic reverse engineering concepts</a>.</em><div class="containbox"> <b>Throughout the analysis below, portions of the <i>ty.c</i> <a href="#source-code">source code</a> are referenced using a bracketed "[1]" annotation. This source code and all annotations are provided at the bottom of the page. In most cases, code snippets are also provided directly below the paragraph where the code is referenced.</b></div><hr /> <center><img src="https://shellsharks-images.s3.amazonaws.com/2019/vlc.mini.svg" alt="vlc" width="125px" /></center><h2 id="explanation-of-source-code">Explanation of Source Code</h2><p>When VLC plays a <em>.ty</em> or any other file and encounters a certain sequence of bytes <strong>[13]</strong> it calls the <em>parse_master</em> function with <em>p_demux</em> as an argument <strong>[15]</strong>. <em>p_demux</em> is the remaining (unprocessed) bytes of the input video file. The <em>peek</em> function <strong>[14]</strong> compares the current 4 bytes in the input stream to the magic bytes <strong>[13]</strong> and then rewinds <em>p_demux</em> to the offset beginning with those same bytes (in other words, if the magic bytes are encountered, <em>parse_master</em> is passed the input stream (<em>p_demux</em>) starting with the offset of the magic bytes).<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define TIVO_PES_FILEID   ( 0xf5467abd ) [13]
</span><span class="p">...</span>
<span class="cm">/* check if it's a PART Header */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">U32_AT</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">p_peek</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="n">TIVO_PES_FILEID</span> <span class="p">)</span>	<span class="p">[</span><span class="mi">14</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="cm">/* parse master chunk */</span>
        <span class="n">parse_master</span><span class="p">(</span><span class="n">p_demux</span><span class="p">);</span> <span class="p">[</span><span class="mi">15</span><span class="p">]</span>
</code></pre></div></div><p>As you can see in the image below, the byte stream begins with the magic bytes “<em>F5 46 7a bd</em>”.<p><img src="https://shellsharks-images.s3.amazonaws.com/videotybytes.png" alt="Video.ty+ Bytes" /><p>The <em>parse_master</em> function begins with declaring a series of variables including an array of 32 8-bit integers (<em>mst_buf</em>) <strong>[1]</strong> as well as two 32-bit integers (<em>i</em> and <em>i_map_size</em>) <strong>[2]</strong>. Further down, there is a call to thhe <em>stream_Read</em> function which reads 32 bytes from the input stream into <em>mst_buf</em> <strong>[3]</strong>. The following line <strong>[4]</strong>, sets <em>i_map_size</em> to the 32-bit value located at <em>mst_buf[20]</em>. The variable <em>i</em> is then initialized <strong>[6]</strong> to the 32-bit value at the end of the <em>mst_buf</em> buffer (<em>mst_buf[28]</em>). Finally, the <em>i_seq_table_size</em> data element in the <em>p_sys</em> structure is set to the result of the expression <em>i / (8 + i_map_size)</em> <strong>[7]</strong>.<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">demux_sys_t</span> <span class="o">*</span><span class="n">p_sys</span> <span class="o">=</span> <span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">p_sys</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">mst_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_map_size</span><span class="p">;</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">...</span>
<span class="n">stream_Read</span><span class="p">(</span><span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="n">mst_buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">i_map_size</span> <span class="o">=</span> <span class="n">U32_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>  <span class="cm">/* size of bitmask, in bytes */</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_bits_per_seq_entry</span> <span class="o">=</span> <span class="n">i_map_size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">U32_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>   <span class="cm">/* size of SEQ table, in bytes */</span>	<span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i_map_size</span><span class="p">);</span>	<span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</code></pre></div></div><p>After these initial variables are initialized, a <em>malloc</em> call is made <strong>[8]</strong> with the size argument passed as <em>i_seq_table_size * sizeof(ty_seq_table_t)</em> (the size of the <em>ty_seq_table_t</em> data element is 16). The resulting memory pointer is stored in <em>seq_table</em>.<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="n">ty_seq_table_t</span><span class="p">));</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</code></pre></div></div><p>Further down in the function, a <em>memcpy</em> call is made which takes <em>i_map_size</em> bytes from the <em>mst_buf</em> buffer and writes to the memory location pointed to by <em>seq_table</em> (the pointer returned from our previous <em>malloc</em> call <strong>[12]</strong>).<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chunk_bitmask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">i_map_size</span><span class="p">);</span>	<span class="p">[</span><span class="mi">12</span><span class="p">]</span>
</code></pre></div></div><h2 id="source-code-vulnerability-analysis">Source Code Vulnerability Analysis</h2><p>With an understanding of the source code, let’s analyze the vulnerability… Given <em>i_map_size</em> is a signed integer <strong>[1]</strong>, if we set it to a negative number, say -1 (or <em>FFFFFFFFh</em>) <strong>[4]</strong> and set <em>i</em> to a value of 7 <strong>[6]</strong>, we can get an <em>i_seq_table_size</em> equal to 1 <strong>[7]</strong>. Keep in mind, we can set the values of <em>i_map_size</em> and <em>i</em> arbitrarily <strong>[4]</strong> <strong>[6]</strong> since these values are parsed directly out of <em>mst_buf</em> which comes from user-supplied input. Now, when <em>malloc</em> is called <strong>[8]</strong> the size will be 16 (<em>i_seq_table_size</em> which is 1 multiplied by _sizeof(ty_seq_table_t) which is 16) which will return a pointer to a memory region with <strong>at-least</strong> 16 bytes of memory. Of note here is this is a relatively SMALL memory region (one that would be easier to overflow).<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span> <span class="n">mst_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">...</span>
<span class="n">i_map_size</span> <span class="o">=</span> <span class="n">U32_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>  <span class="cm">/* size of bitmask, in bytes */</span>	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_bits_per_seq_entry</span> <span class="o">=</span> <span class="n">i_map_size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">U32_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>   <span class="cm">/* size of SEQ table, in bytes */</span>	<span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i_map_size</span><span class="p">);</span>	<span class="p">[</span><span class="mi">7</span><span class="p">]</span>

<span class="cm">/* parse all the entries */</span>
<span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="n">ty_seq_table_t</span><span class="p">));</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</code></pre></div></div><p>Within the <em>for</em> loop declaration <strong>[9]</strong>, we see it should execute <em>i_seq_table_size</em> amount of times which we know is 1 (so it should only iterate once through). Unlike the stack-overflow condition seen in a <a href="/vlc-stack-overflow#title">previous post</a>, the <em>stream_Read</em> call within the <em>for</em> loop should execute with no issues (no overflow condition) as it is merely writing 7 bytes from the input stream into <em>mst_buf</em> <strong>[10]</strong>. In order to bypass the <em>if</em> condition <strong>[11]</strong> (which must be done to get to the <em>memcpy</em> function), <em>i_map_size</em> must be &lt;= 8, which we know it <strong>is</strong> as we had previously set it to -1 (<em>FFFFFFFFh</em>). Finally, we get to the <em>memcpy</em> call <strong>[12]</strong> which writes <em>FFFFFFFFh</em> bytes from <em>mst_buf</em> into the memory location pointed to by <em>seq_table</em>. Since <em>memcpy</em> uses the <em>FFFFFFFFh</em> size value as an <strong>unsigned</strong> value, this is a very large amount of data it attempts to write into memory which overflows the allocated memory buffer which was only 16 when first passed to the <em>malloc</em> function earlier. This will result in an access violation and the program crashes due to overflowing the heap buffer!<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">stream_Read</span><span class="p">(</span><span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="n">mst_buf</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">i_map_size</span><span class="p">);</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l_timestamp</span> <span class="o">=</span> <span class="n">U64_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i_map_size</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>	<span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">msg_Err</span><span class="p">(</span><span class="n">p_demux</span><span class="p">,</span> <span class="s">"Unsupported SEQ bitmap size in master chunk"</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chunk_bitmask</span><span class="p">,</span> <span class="n">i_map_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chunk_bitmask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">i_map_size</span><span class="p">);</span>	<span class="p">[</span><span class="mi">12</span><span class="p">]</span>
</code></pre></div></div><h2 id="assembly-code-vulnerability-analysis">Assembly Code Vulnerability Analysis</h2><p>Analysis of the vulnerability continues by inspecting the disassembled code…<h4 id="initializing-i_map_size-variable-from-the-mst_buf-buffer">Initializing <em>i_map_size</em> variable from the <em>mst_buf</em> buffer</h4><p>After the first of the two <em>stream_Read</em> calls (<em>0x61401C1F</em>), the <em>FFFFFFFFh</em> value passed in via the user inputted <em>.ty</em> file is loaded (via instructions <em>0x61401C24</em>-<em>0x61401C62</em>) onto the stack and stored at offset <em>0x0629FB04</em> (<em>ESP+A0</em>).<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">C24</span>   <span class="mi">0</span><span class="nv">FB6B424</span> <span class="nv">D400000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">ESI</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">D4</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">C2C</span>   <span class="mi">0</span><span class="nv">FB69C24</span> <span class="nv">D500000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">EBX</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">D5</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">C34</span>   <span class="mi">0</span><span class="nv">FB68C24</span> <span class="nv">D700000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">ECX</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">D7</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">C3C</span>   <span class="mi">0</span><span class="nv">FB69424</span> <span class="nv">D600000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">EDX</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">D6</span><span class="p">]</span> <span class="c1">;these 4 grab FFFFFFFF from mst_buf stored on stack</span>
<span class="err">61401</span><span class="nf">C44</span>   <span class="nv">C1E6</span> <span class="mi">18</span>          <span class="nv">SHL</span> <span class="nb">ESI</span><span class="p">,</span><span class="mi">18</span>
<span class="err">61401</span><span class="nf">C47</span>   <span class="mi">89</span><span class="nv">B424</span> <span class="nv">A0000000</span>  <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">],</span><span class="nb">ESI</span>
<span class="err">61401</span><span class="nf">C4E</span>   <span class="nv">C1E3</span> <span class="mi">10</span>          <span class="nv">SHL</span> <span class="nb">EBX</span><span class="p">,</span><span class="mi">10</span>
<span class="err">61401</span><span class="nf">C51</span>   <span class="mi">099</span><span class="nv">C24</span> <span class="nv">A0000000</span>  <span class="nv">OR</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">],</span><span class="nb">EBX</span>
<span class="err">61401</span><span class="nf">C58</span>   <span class="nv">C1E2</span> <span class="mi">08</span>          <span class="nv">SHL</span> <span class="nb">EDX</span><span class="p">,</span><span class="mi">8</span>
<span class="err">61401</span><span class="nf">C5B</span>   <span class="mi">098</span><span class="nv">C24</span> <span class="nv">A0000000</span>  <span class="nv">OR</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">],</span><span class="nb">ECX</span> <span class="c1">;these 6 instructions convert endianness of bytes from input buffer</span>
<span class="err">61401</span><span class="nf">C62</span>   <span class="mi">099424</span> <span class="nv">A0000000</span>  <span class="nv">OR</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">],</span><span class="nb">EDX</span> <span class="c1">;storing in 060BFB04</span>
</code></pre></div></div><h4 id="initializing-i-variable-from-the-mst_buf-buffer">Initializing <em>i</em> variable from the <em>mst_buf</em> buffer</h4><p>The <em>i</em> variable has the user inputted value loaded into it from the <em>mst_buf</em> array. This value is stored on the stack at <em>ESP+A4</em><div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">C83</span>   <span class="mi">0</span><span class="nv">FB68424</span> <span class="nv">DC00000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">EAX</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">DC</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">C8B</span>   <span class="mi">0</span><span class="nv">FB6B424</span> <span class="nv">DD00000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">ESI</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">DD</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">C93</span>   <span class="mi">0</span><span class="nv">FB69C24</span> <span class="nv">DF00000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">EBX</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">DF</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">C9B</span>   <span class="mi">0</span><span class="nv">FB68C24</span> <span class="nv">DE00000</span><span class="o">&gt;</span><span class="nv">MOVZX</span> <span class="nb">ECX</span><span class="p">,</span><span class="kt">BYTE</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">DE</span><span class="p">]</span> <span class="c1">;grabs DWORD from input buffer</span>
<span class="err">61401</span><span class="nf">CA3</span>   <span class="nv">C1E0</span> <span class="mi">18</span>          <span class="nv">SHL</span> <span class="nb">EAX</span><span class="p">,</span><span class="mi">18</span>
<span class="err">61401</span><span class="nf">CA6</span>   <span class="nv">C1E6</span> <span class="mi">10</span>          <span class="nv">SHL</span> <span class="nb">ESI</span><span class="p">,</span><span class="mi">10</span>
<span class="err">61401</span><span class="nf">CA9</span>   <span class="mi">09</span><span class="nv">F0</span>             <span class="nv">OR</span> <span class="nb">EAX</span><span class="p">,</span><span class="nb">ESI</span>
<span class="err">61401</span><span class="nf">CAB</span>   <span class="nv">C1E1</span> <span class="mi">08</span>          <span class="nv">SHL</span> <span class="nb">ECX</span><span class="p">,</span><span class="mi">8</span>
<span class="err">61401</span><span class="nf">CAE</span>   <span class="mi">09</span><span class="nv">D8</span>             <span class="nv">OR</span> <span class="nb">EAX</span><span class="p">,</span><span class="nb">EBX</span>
<span class="err">61401</span><span class="nf">CB0</span>   <span class="mi">09</span><span class="nv">C8</span>             <span class="nv">OR</span> <span class="nb">EAX</span><span class="p">,</span><span class="nb">ECX</span>
<span class="err">61401</span><span class="nf">CB2</span>   <span class="mi">89</span><span class="nv">BC24</span> <span class="nv">A4000000</span>  <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A4</span><span class="p">],</span><span class="nb">EDI</span> <span class="c1">;store i value on stack</span>
</code></pre></div></div><h4 id="i_seq_table_size-expression"><em>i_seq_table_size</em> expression</h4><p>At instruction <em>0x61401C70</em> the <em>i_map_size</em> value is loaded into <em>EDI</em> from the stack. 8 is added to it and then it is stored at an address on the stack.<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">C70</span>   <span class="mi">8</span><span class="nv">BBC24</span> <span class="nv">A0000000</span>  <span class="nv">MOV</span> <span class="nb">EDI</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">]</span>
<span class="err">…</span>
<span class="err">61401</span><span class="nf">C80</span>   <span class="mi">83</span><span class="nv">C7</span> <span class="mi">08</span>          <span class="nv">ADD</span> <span class="nb">EDI</span><span class="p">,</span><span class="mi">8</span>
<span class="err">…</span>
<span class="err">61401</span><span class="nf">CB2</span>   <span class="mi">89</span><span class="nv">BC24</span> <span class="nv">A4000000</span>  <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A4</span><span class="p">],</span><span class="nb">EDI</span>
</code></pre></div></div><p><strong>The stack now looks like…</strong><br /> 0629FB04 FFFFFFFF ÿÿÿÿ<br /> 0629FB08 00000007 …<p>From here, the rest of <em>i_seq_table_size</em> is calculated.<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">CB9</span>   <span class="mi">99</span>               <span class="nv">CDQ</span> <span class="c1">; sign extend EAX into EDX</span>
<span class="err">61401</span><span class="nf">CBA</span>   <span class="nv">F7BC24</span> <span class="nv">A4000000</span>  <span class="nv">IDIV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A4</span><span class="p">]</span>
<span class="err">61401</span><span class="nf">CC1</span>   <span class="mi">8985</span> <span class="nv">C8BE0000</span>    <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">EBP</span><span class="o">+</span><span class="nv">BEC8</span><span class="p">],</span><span class="nb">EAX</span>
</code></pre></div></div><h4 id="malloc-call"><em>malloc</em> call</h4><p><em>EAX</em>, now with a value of 1 is shifted left to get a value of <em>10h</em> (which is 16) and <em>malloc</em> is called with this size value. (Remember, <em>malloc</em> was called with a value of 16 as this is the size of <em>ty_seq_table_t</em>.)<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">CBA</span>   <span class="nv">F7BC24</span> <span class="nv">A4000000</span>  <span class="nv">IDIV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A4</span><span class="p">]</span> <span class="c1">; SETS EAX to 1</span>
<span class="err">…</span>
<span class="err">61401</span><span class="nf">CC7</span>   <span class="nv">C1E0</span> <span class="mi">04</span>          <span class="nv">SHL</span> <span class="nb">EAX</span><span class="p">,</span><span class="mi">4</span>
<span class="err">61401</span><span class="nf">CCA</span>   <span class="mi">890424</span>           <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="p">],</span><span class="nb">EAX</span>
<span class="err">61401</span><span class="nf">CCD</span>   <span class="nv">E8</span> <span class="mi">4</span><span class="nv">E580000</span>      <span class="nv">CALL</span> <span class="o">&lt;</span><span class="nv">JMP.</span><span class="o">&amp;</span><span class="nv">msvcrt.malloc</span><span class="o">&gt;</span>
</code></pre></div></div><p><em>malloc</em> returns with a memory pointer in <em>EAX</em> of (in my case it is <em>0x04909420</em>.)<h4 id="no-stream_read-overwrite-issue">No <em>stream_Read</em> overwrite issue</h4><p>The following assembly instructions set up the second <em>stream_Read</em> call which has a size value parameter of 7 which will not overwrite the <em>mst_buf</em> size of 32.<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">D4A</span>   <span class="mi">894</span><span class="nv">C24</span> <span class="mi">04</span>        <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span><span class="nb">ECX</span> <span class="c1">;pointer to mst_buf</span>
<span class="err">61401</span><span class="nf">D4E</span>   <span class="mi">897424</span> <span class="mi">08</span>        <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="nb">ESI</span> <span class="c1">;size value of 7</span>
<span class="err">…</span>
<span class="err">61401</span><span class="nf">D57</span>   <span class="mi">893</span><span class="nv">C24</span>           <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="p">],</span><span class="nb">EDI</span> <span class="c1">;pointer to P_demux stream</span>
<span class="err">61401</span><span class="nf">D5A</span>   <span class="nv">E8</span> <span class="mi">31510000</span>      <span class="nv">CALL</span> <span class="o">&lt;</span><span class="nv">JMP.</span><span class="o">&amp;</span><span class="nv">libvlccore.stream_Read</span><span class="o">&gt;</span>
</code></pre></div></div><h4 id="bypass-if-statement">Bypass <em>if</em> statement</h4><p>The following shows the <em>if</em> statement in assembly ensuring that <em>i_map_size</em> is not greater than 8.<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">EA5</span>   <span class="mi">83</span><span class="nv">BC24</span> <span class="nv">A0000000</span> <span class="o">&gt;</span><span class="nv">CMP</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">],</span><span class="mi">8</span>
<span class="err">61401</span><span class="nf">EAD</span>   <span class="mi">894</span><span class="nv">C3B</span> <span class="mi">04</span>        <span class="nv">MOV</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">DS</span><span class="p">:[</span><span class="nb">EBX</span><span class="o">+</span><span class="nb">EDI</span><span class="o">+</span><span class="mi">4</span><span class="p">],</span><span class="nb">ECX</span>
<span class="err">61401</span><span class="nf">EB1</span>  <span class="o">^</span><span class="mi">0</span><span class="nv">F8F</span> <span class="mi">3</span><span class="nv">AFEFFFF</span>    <span class="nv">JG</span> <span class="nv">libty_pl.61401CF1</span> <span class="c1">; This jump is not taken as it is not greater</span>
</code></pre></div></div><h4 id="memcpy-call"><em>memcpy</em> call</h4><p>The following instructions set up and execute the <em>memcpy</em>.<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">EBF</span>   <span class="mi">8</span><span class="nv">B9424</span> <span class="nv">A0000000</span>  <span class="nv">MOV</span> <span class="nb">EDX</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">A0</span><span class="p">]</span> <span class="c1">; FFFFFFFF into EDX</span>
<span class="err">61401</span><span class="nf">EC6</span>   <span class="mi">01</span><span class="nv">F1</span>             <span class="nv">ADD</span> <span class="nb">ECX</span><span class="p">,</span><span class="nb">ESI</span> <span class="c1">; ECX is 0 so this sticks ESI (malloc pointer) into ECX</span>
<span class="err">61401</span><span class="nf">EC8</span>   <span class="mi">83</span><span class="nv">FA</span> <span class="mi">07</span>          <span class="nv">CMP</span> <span class="nb">EDX</span><span class="p">,</span><span class="mi">7</span> <span class="c1">; Compares EDX FFFFFFFF to 7</span>
<span class="err">61401</span><span class="nf">ECB</span>   <span class="mi">8</span><span class="nv">D79</span> <span class="mi">08</span>          <span class="nv">LEA</span> <span class="nb">EDI</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">DS</span><span class="p">:[</span><span class="nb">ECX</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="c1">;</span>
<span class="err">61401</span><span class="nf">ECE</span>   <span class="mi">8</span><span class="nv">DB424</span> <span class="nv">C8000000</span>  <span class="nv">LEA</span> <span class="nb">ESI</span><span class="p">,</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">SS</span><span class="p">:[</span><span class="nb">ESP</span><span class="o">+</span><span class="nv">C8</span><span class="p">]</span> <span class="c1">;LEA on ESI which has malloc result pointer</span>
<span class="err">61401</span><span class="nf">ED5</span>   <span class="mi">76</span> <span class="mi">29</span>            <span class="nv">JBE</span> <span class="nv">SHORT</span> <span class="nv">libty_pl.61401F00</span> <span class="c1">; continues on as last CMP set to 1</span>
<span class="err">61401</span><span class="nf">ED7</span>   <span class="nv">F7C7</span> <span class="mi">04000000</span>    <span class="nv">TEST</span> <span class="nb">EDI</span><span class="p">,</span><span class="mi">4</span> <span class="c1">; EDI is not 4 (its a memory pointer)</span>
<span class="err">61401</span><span class="nf">EDD</span>   <span class="mi">74</span> <span class="mi">21</span>            <span class="nv">JE</span> <span class="nv">SHORT</span> <span class="nv">libty_pl.61401F00</span> <span class="c1">; this jump happens</span>

<span class="nf">Which</span> <span class="nv">jumps</span> <span class="nv">to</span><span class="err">…</span>
<span class="err">61401</span><span class="nf">F00</span>   <span class="mi">89</span><span class="nv">D1</span>             <span class="nv">MOV</span> <span class="nb">ECX</span><span class="p">,</span><span class="nb">EDX</span> <span class="c1">; moves FFFFFFFF into ECX</span>
<span class="err">…</span>
<span class="err">61401</span><span class="nf">F09</span>   <span class="nv">F3</span><span class="p">:</span><span class="nv">A5</span>            <span class="nv">REP</span> <span class="nv">MOVS</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">ES</span><span class="p">:[</span><span class="nb">EDI</span><span class="p">],</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">DS</span><span class="o">&gt;</span> <span class="c1">; memcpy</span>
</code></pre></div></div><p>Here is a look at the registers at the time of the crash.<p><strong>Registers at time of crash</strong><br /> EAX 00004A00<br /> ECX 3FFF16CA<br /> EDX FFFFFFFF<br /> EBX 0487AEE8<br /> ESP 061BFA64<br /> EBP 047F7CE0<br /> ESI 061FA000<br /> EDI 048B53C4<br /> EIP 61401F09 libty_pl.61401F09<p>The access violation occurs during the course of the <em>memcpy</em> call (specifically during the <em>REP MOVS</em> instruction). The violation references the memory address stored in <em>ESI</em>. <strong>This is evidence of the heap overflow!</strong><div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">61401</span><span class="nf">F09</span>   <span class="nv">F3</span><span class="p">:</span><span class="nv">A5</span>            <span class="nv">REP</span> <span class="nv">MOVS</span> <span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">ES</span><span class="p">:[</span><span class="nb">EDI</span><span class="p">],</span><span class="kt">DWORD</span> <span class="nv">PTR</span> <span class="nb">DS</span><span class="o">&gt;</span> <span class="c1">; memcpy</span>
</code></pre></div></div><h2 id="patching-the-code">Patching the Code</h2><p>The issue with the heap overflow described above is that you can have a <em>memcpy</em> that attempts to copy data of size <em>i_map_size</em> (which can be arbitrarily set and very large) into a small buffer. The only validation of <em>i_map_size</em> is done via the <em>if</em> condition <strong>[11]</strong> which checks to see if it is greater than 8. What this doesn’t consider is whether <em>i_map_size</em> is some value 0 or smaller (even up to <em>FFFFFFFFh</em>!). Implementing more robust validation of <em>i_map_size</em> to ensure it can only be a value between 1 and 8 is one way to mitigate the vulnerability.<p>So if we changed …<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">i_map_size</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div><p>to…<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">i_map_size</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i_map_size</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div><p>then this could solve the issue!<h2 id="source-code">Source Code</h2><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_master</span><span class="p">(</span><span class="n">demux_t</span> <span class="o">*</span><span class="n">p_demux</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">demux_sys_t</span> <span class="o">*</span><span class="n">p_sys</span> <span class="o">=</span> <span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">p_sys</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">mst_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_map_size</span><span class="p">;</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="kt">int64_t</span> <span class="n">i_save_pos</span> <span class="o">=</span> <span class="n">stream_Tell</span><span class="p">(</span><span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
    <span class="kt">int64_t</span> <span class="n">i_pts_secs</span><span class="p">;</span>

    <span class="cm">/* Note that the entries in the SEQ table in the stream may have
       different sizes depending on the bits per entry.  We store them
       all in the same size structure, so we have to parse them out one
       by one.  If we had a dynamic structure, we could simply read the
       entire table directly from the stream into memory in place. */</span>

    <span class="cm">/* clear the SEQ table */</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">);</span>

    <span class="cm">/* parse header info */</span>
    <span class="n">stream_Read</span><span class="p">(</span><span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="n">mst_buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">i_map_size</span> <span class="o">=</span> <span class="n">U32_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>  <span class="cm">/* size of bitmask, in bytes */</span>	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_bits_per_seq_entry</span> <span class="o">=</span> <span class="n">i_map_size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">U32_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">28</span><span class="p">]);</span>   <span class="cm">/* size of SEQ table, in bytes */</span>	<span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="n">i_map_size</span><span class="p">);</span>	<span class="p">[</span><span class="mi">7</span><span class="p">]</span>

    <span class="cm">/* parse all the entries */</span>
    <span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ty_seq_table_t</span><span class="p">));</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">i_seq_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">stream_Read</span><span class="p">(</span><span class="n">p_demux</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="n">mst_buf</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">i_map_size</span><span class="p">);</span> <span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">l_timestamp</span> <span class="o">=</span> <span class="n">U64_AT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i_map_size</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>	<span class="p">[</span><span class="mi">11</span><span class="p">]</span>
            <span class="n">msg_Err</span><span class="p">(</span><span class="n">p_demux</span><span class="p">,</span> <span class="s">"Unsupported SEQ bitmap size in master chunk"</span><span class="p">);</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chunk_bitmask</span><span class="p">,</span> <span class="n">i_map_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="n">p_sys</span><span class="o">-&gt;</span><span class="n">seq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chunk_bitmask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mst_buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">i_map_size</span><span class="p">);</span>	<span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="o">=================</span> <span class="n">CODE</span> <span class="n">BREAK</span> <span class="o">=====================</span>

<span class="cp">#define TIVO_PES_FILEID   ( 0xf5467abd ) [13]
</span>
<span class="o">=================</span> <span class="n">CODE</span> <span class="n">BREAK</span> <span class="o">=====================</span>

<span class="cm">/* check if it's a PART Header */</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">U32_AT</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">p_peek</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span> <span class="o">==</span> <span class="n">TIVO_PES_FILEID</span> <span class="p">)</span>	<span class="p">[</span><span class="mi">14</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="cm">/* parse master chunk */</span>
        <span class="n">parse_master</span><span class="p">(</span><span class="n">p_demux</span><span class="p">);</span> <span class="p">[</span><span class="mi">15</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">get_chunk_header</span><span class="p">(</span><span class="n">p_demux</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div></div></article><hr class="fin"><div id="poststats" class="containbox" style="margin: auto;"> <span class="time"><i class="ph ph-calendar-dot"></i> Published: <span class="dt-published">October 8, 2019</span></span> <a class="u-url u-uid" href></a><br> <span class='time'><i class="ph ph-calendar-dot"></i> Updated: <span class="dt-updated">October 9, 2019</span></span><br/> <span class="categories"><i class="ph ph-tag"></i> Tags: <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=dev">#dev</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=cve">#cve</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=infosec">#infosec</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=red">#red</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=reverseengineering">#reverseengineering</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=ida">#ida</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=exploitdev">#exploitdev</a></span> <span class="primarybg" style="border-radius:15px;padding:0px 5px 0px 5px;"><a class="p-category" href="/tags?tag=technical">#technical</a></span> </span><br/> <span class="time"><i class="ph ph-pencil"></i> Word count: 3419</span> <span class="p-summary" style="display:none;">A walkthrough of identifying a heap-based buffer overflow vulnerability in VLC.</span></div><br/><div class="PageNavigation"> <a class="prev" style="margin-right: 2em;" href="/vlc-stack-overflow#title">&laquo; Stack Buffer Overflow in VLC v0.9.4</a><div style="float:right;"><a class="next" href="/minix-character-device-driver#title" style="margin-right:0;">Exploring Minix Character Device Drivers &raquo;</a></div></div></main><aside class="container_item"></aside><footer class="container_item"> <center><span style="color:var(--light-font-color); font-size:.8em; font-style:italic; position:relative; top:25px;">Brought to you with <i class="ph-fill ph-heart-straight" style="color:var(--accent-color);"></i> by <a href="https://shellsharks.com/about">Shellsharks</a></span></center> <center> <img id="sharkfooter" src="/assets/img/sharks-circling.png" alt="Circling Sharks" style="width:150px;"></img> </center></footer></div><noscript><div class="panel" align="center" style="font-weight:bold;"><h1>Please enable JavaScript.</h1></div></noscript> <script src="/assets/js/themeswitcher.js"></script>
